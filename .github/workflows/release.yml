name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag name for release'
        required: true
        default: 'v0.1.0'

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          pkg-config \
          libogg-dev \
          libvorbis-dev \
          libopus-dev \
          libflac-dev \
          libmpg123-dev \
          libmp3lame-dev \
          libfdk-aac-dev

    - name: Build (All Codecs)
      run: |
        mkdir build
        cd build
        cmake .. \
          -DBUILD_ALL_CODECS=ON \
          -DBUILD_ENCODERS=ON \
          -DBUILD_DECODERS=ON \
          -DCMAKE_BUILD_TYPE=Release
        make -j$(nproc)

    - name: Package
      run: |
        mkdir -p release/native-linux-x64
        cp build/libmuxaudio.so* build/libmuxaudio-static.a build/mux build/demux release/native-linux-x64/
        cd release
        tar czf muxaudio-native-linux-x64.tar.gz native-linux-x64/

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-release
        path: release/muxaudio-native-linux-x64.tar.gz
        retention-days: 1

  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11

    - name: Build (All Codecs)
      run: |
        mkdir build
        cd build
        cmake .. -DBUILD_ALL_CODECS=ON `
          -DBUILD_ENCODERS=ON `
          -DBUILD_DECODERS=ON `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_TOOLCHAIN_FILE="${env:VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake" `
          -DVCPKG_TARGET_TRIPLET=x64-windows
        cmake --build . --config Release -j $env:NUMBER_OF_PROCESSORS

    - name: Package
      run: |
        mkdir -p release/windows-x64

        # Copy muxaudio binaries
        Copy-Item build/Release/*.dll release/windows-x64/
        Copy-Item build/Release/*.lib release/windows-x64/
        Copy-Item build/Release/*.exe release/windows-x64/

        # Copy codec DLLs from vcpkg
        $vcpkgBin = "$env:VCPKG_ROOT/installed/x64-windows/bin"
        Copy-Item "$vcpkgBin/ogg.dll" release/windows-x64/
        Copy-Item "$vcpkgBin/vorbis.dll" release/windows-x64/
        Copy-Item "$vcpkgBin/vorbisenc.dll" release/windows-x64/
        Copy-Item "$vcpkgBin/opus.dll" release/windows-x64/
        Copy-Item "$vcpkgBin/FLAC.dll" release/windows-x64/
        Copy-Item "$vcpkgBin/mpg123.dll" release/windows-x64/
        Copy-Item "$vcpkgBin/fdk-aac-2.dll" release/windows-x64/

        cd release
        Compress-Archive -Path windows-x64 -DestinationPath muxaudio-windows-x64.zip

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-release
        path: release/muxaudio-windows-x64.zip
        retention-days: 1

  build-wasm:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Emscripten
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: 'latest'

    - name: Build WASM (Decoder Only - All Codecs)
      run: |
        mkdir build
        cd build
        emcmake cmake .. \
          -DBUILD_ALL_CODECS=ON \
          -DBUILD_ENCODERS=OFF \
          -DBUILD_DECODERS=ON \
          -DCMAKE_BUILD_TYPE=Release
        make -j$(nproc)

    - name: Package
      run: |
        mkdir -p release/wasm-decoder
        cp build/muxaudio.js release/wasm-decoder/
        cp build/muxaudio.wasm release/wasm-decoder/
        cp wasm/muxaudio.wrapper.js release/wasm-decoder/
        [ -f wasm/test.html ] && cp wasm/test.html release/wasm-decoder/ || true

        # Create build info
        cat > release/wasm-decoder/BUILD_INFO.txt << EOF
        MuxAudio WASM Build
        ===================
        Version: ${GITHUB_REF_NAME}
        Commit: ${GITHUB_SHA}
        Date: $(date -u)

        Configuration:
        - Codecs: PCM, Vorbis, Opus, FLAC, MP3 (decode only)
        - Encoders: Disabled
        - Decoders: Enabled

        Module Size: $(du -h build/muxaudio.wasm | cut -f1)
        EOF

        cd release
        tar czf muxaudio-wasm-decoder.tar.gz wasm-decoder/

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: wasm-release
        path: release/muxaudio-wasm-decoder.tar.gz
        retention-days: 1

  create-release:
    needs: [build-linux, build-windows, build-wasm]
    runs-on: ubuntu-latest

    steps:
    - name: Download Linux Artifact
      uses: actions/download-artifact@v4
      with:
        name: linux-release
        path: release

    - name: Download Windows Artifact
      uses: actions/download-artifact@v4
      with:
        name: windows-release
        path: release

    - name: Download WASM Artifact
      uses: actions/download-artifact@v4
      with:
        name: wasm-release
        path: release

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name || github.event.inputs.tag }}
        name: Release ${{ github.ref_name || github.event.inputs.tag }}
        body: |
          ## MuxAudio Release ${{ github.ref_name || github.event.inputs.tag }}

          ### Native Linux Build
          - Shared library: `libmuxaudio.so`
          - Static library: `libmuxaudio-static.a`
          - CLI tools: `mux`, `demux`
          - All codecs enabled (PCM, Vorbis, Opus, FLAC, MP3, AAC)

          ### Windows Build
          - DLL: `muxaudio.dll`
          - Import library: `muxaudio.lib`
          - Static library: `muxaudio-static.lib`
          - CLI tools: `mux.exe`, `demux.exe`
          - All codecs enabled (PCM, Vorbis, Opus, FLAC, MP3, AAC)

          ### WASM Build
          - Decoder-only build for browser use
          - Codecs: PCM, Vorbis, Opus, FLAC, MP3
          - Files: `muxaudio.js`, `muxaudio.wasm`, `muxaudio.wrapper.js`

          ### Installation

          **Linux:**
          ```bash
          tar xzf muxaudio-native-linux-x64.tar.gz
          sudo cp native-linux-x64/libmuxaudio.so* /usr/local/lib/
          sudo cp native-linux-x64/mux native-linux-x64/demux /usr/local/bin/
          sudo ldconfig
          ```

          **Windows:**
          ```powershell
          Expand-Archive muxaudio-windows-x64.zip
          # Copy DLL and EXE files to your project or system PATH
          ```

          **WASM:**
          ```bash
          tar xzf muxaudio-wasm-decoder.tar.gz
          # Use files in wasm-decoder/ in your web project
          ```
        draft: false
        prerelease: false
        files: |
          release/muxaudio-native-linux-x64.tar.gz
          release/muxaudio-windows-x64.zip
          release/muxaudio-wasm-decoder.tar.gz
